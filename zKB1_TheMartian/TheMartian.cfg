AGENT { name = NASA
	description = National Aeronautics and Space Administration
    logoURL = zKB1_TheMartian/Flags/NASA
    logoScaledURL = zKB1_TheMartian/Flags/NASA_scaled
}

CONTRACT_GROUP { name = NASA
	agent = NASA
    minVersion = 1.29.0
    displayName = NASA
}

CONTRACT_TYPE { name = TheMartian
    title = The Martian
    description = Bring Watney Home
    synopsis = Mark K. Watney was stranded on Mars, and must survive.  Bring him home.
	agent = NASA
	group = NASA
    completedMessage = You have done the thing.
    targetBody = Mars
    rewardFunds = 1000000.0
    rewardScience = 100.0
    maxSimultaneous = 1

//#region PROLOGUE
	PARAMETER { name = Prologue
		type = Duration
		disableOnStateChange = true
		duration = 1m
	}
	PARAMETER { name = MarkInHabVPG
		type = VesselParameterGroup
		vessel = Hab
		hideVesselName = true
		hideChildren = true
		disableOnStateChange = true
		title = Get Mark to the Hab!
		PARAMETER { name = HasCrew
			type = HasCrew
			kerbal = Mark Watney
		}
	}
	BEHAVIOUR { name = Prologue_DialogBoxes
		type = DialogBox
		DIALOG_BOX { name = START
            position = CENTER
            title = The Martian contract has started.
            condition = CONTRACT_ACCEPTED
            TEXT
            {
                text = Save Mark Watney!
            }
        }
        DIALOG_BOX { name = Prologue
            position = CENTER
            title = START
            titleColor = #F6F006
            condition = PARAMETER_COMPLETED
            parameter = Prologue
            width = 0.4
            IMAGE
            {
                url = zKB1_TheMartian/images/TheMartian1
            }
            TEXT
            {
                text = Stranded on Mars!
                fontSize = 48
                fontColor = #DDDDDD
            }
            BREAK { }
            TEXT
            {
                text = Gonna survive
                fontSize = 48
                fontColor = #DDDDDD
            }
            IMAGE
            {
                url = zKB1_TheMartian/images/TheMartian2
            }
        }
	}
//#endregion

//#region VesselParameterGroups
	PARAMETER { name = DefineHabVPG
		type = VesselParameterGroup
		hideVesselName = true
		hidden = true
        define = Hab
		PARAMETER { type = VesselIsType
			vesselType = Base
		}
	}
	PARAMETER { name = DefineRoverVPG
        type = VesselParameterGroup
		hideVesselName = true
		hidden = true
        define = Rover
		PARAMETER
		{
			type = VesselIsType
			vesselType = Rover
		}
	}
	PARAMETER { name = DefineMAVVPG
        type = VesselParameterGroup
		hideVesselName = true
		hidden = true
        define = MAV
		PARAMETER
		{
			type = VesselIsType
			vesselType = Ship
		}
	}
	PARAMETER { name = DefineHermesVPG
        type = VesselParameterGroup
		hideVesselName = true
		hidden = true
        define = Hermes
		PARAMETER
		{
			type = VesselIsType
			vesselType = Ship
		}
	}
//#endregion

//#region Spawn Craft
	BEHAVIOUR
	{
		name = SpawnRTG
		type = SpawnVessel
		switchtoTrackingStation = true
		VESSEL
		{
			name = RTG
			craftURL = zKB1_TheMartian/Ships/RTG.craft
			targetBody = Mars
			owned = false
			lat = -0.097992729723051
			lon = 0.425467968966
		}
		CONDITION 
		{
			condition = PARAMETER_COMPLETED
			parameter = tbd // 4km from Hab
		}
	}
	BEHAVIOUR
	{
		name = JPL_Pathfinder
		type = SpawnVessel
		VESSEL
		{
			name = JPL Pathfinder
			craftURL = zKB1_TheMartian/Ships/PathfinderJPL.craft
			vesselType = Probe
			owned = true
			targetBody = Earth
			pqsCity = KSC
			pqsOffset = -257.45882395621, -241.805869088918, 45.9450664848323
		}
		CONDITION 
		{
			condition = PARAMETER_COMPLETED
			parameter = tbd // reached Pathfinder last known location
		}
	}
	BEHAVIOUR
	{
		name = SpawnPathfinderProbe
		type = SpawnVessel
		switchtoTrackingStation = true
		VESSEL
		{
			name = Pathfinder Probe
			craftURL = zKB1_TheMartian/Ships/PathfinderProbe.craft
			targetBody = Mars
			owned = false
			lat = -0.096992729723051
			lon = 0.425467968966
		}
		CONDITION 
		{
			condition = PARAMETER_COMPLETED
			parameter = tbd // reached Pathfinder last known location
		}
	}
	BEHAVIOUR
	{
		name = SpawnHermes
		type = SpawnVessel
		deferVesselCreation = true
		switchtoTrackingStation = false
		VESSEL
		{
			name = Hermes
			craftURL = zKB1_TheMartian/Ships/Hermes.craft
			vesselType = Station
			targetBody = Sun
			owned = true
			ORBIT
			{
				SMA = 175940521316.07458
				ECC = 0.1926885015598237
				INC = 25.785525853918461
				LPE = 119.00535216073439
				LAN = 357.98176352921786
				MNA = 3.6047752347808406
				EPH = 2680381039.204751
				REF = 0
			}
            CREW {
				name = Melissa Lewis
				gender = Female 
			}
			CREW {
				name = Rick Martinez
				gender = Male
			}
			CREW {
				name = Chris Beck
				gender = Male
			}
			CREW {
				name = Alex Vogel
				gender = Male
			}
			CREW {
				name = Beth Johanssen
				gender = Female
			}
		}
		CONDITION 
		{
			condition = PARAMETER_COMPLETED
			parameter = kOSparam_Pathfinder4
		}
	}
	BEHAVIOUR
	{
		name = SpawnMAV
		type = SpawnVessel
		switchtoTrackingStation = true
		VESSEL
		{
			name = Ares IV MAV
			craftURL = zKB1_TheMartian/Ships/MAV.craft
			targetBody = Mars
			owned = false
			lat = -0.197992729723051
			lon = 0.425467968966
		}
		CONDITION 
		{
			condition = PARAMETER_COMPLETED
			parameter = tbd //reached location
		}
	}

//#endregion

//#region		Act 1 - Soil and Water (PARAMETERS)
	PARAMETER {	name = Act_1
		type = Sequence
		title = Act 1: Mars will come to fear my botany powers
		completeInSequence = true
		failWhenCompleteOutOfOrder = false
		hiddenParameter = SoilSequence
		hiddenParameter = WaterSequence
		hiddenParameter = AfterSoil

		PARAMETER {	name = SoilSequence
			type = Sequence
			title = Crops need farmable soil
			completeInSequence = true
			failWhenCompleteOutOfOrder = false
			hiddenParameter = RoverDirtVPG
			hiddenParameter = HabDirtVPG
			hiddenParameter = CreateSoilVPG
			
			PARAMETER { name = kOSparam_Hab0
				type = AtLeast
				count = 99
				title = Analyze regolith samples
				notes = The Hab has dirt samples that need to be analyzed.  The resultant data will show the lowest concentration of perchlorates and the source location of each sample.
			}
			PARAMETER { name = RoverDirtVPG
				type = VesselParameterGroup
				vessel = Rover
				hideVesselName = true
				hideChildren = true
				completeInSequence = true
				disableOnStateChange = true
				title = Dig up some dirt
				notes = Arrive at the basalt flats with the equipment to dig up low-perchlorate dirt
				PARAMETER { name = PartValidationSmallTank
					type = PartValidation
					part = SmallTank
					completeInSequence = true
					minCount = 1
				}
				PARAMETER { name = VisitWaypointDirtPile1
					type = VisitWaypoint
					completeInSequence = true
					index = 0
					distance = 50
					showMessages = true
				}
			}
			PARAMETER { name = HabDirtVPG
				type = VesselParameterGroup
				vessel = Hab
				hideVesselName = true
				hideChildren = true
				completeInSequence = true
				disableOnStateChange = true
				title = Dump dirt into the Hab
				notes = Connect the transfer hose on Airlock 1 to the storage tank port, dump the dirt into the Hab, then disconnect.
				PARAMETER { name = HasResourceDirtInVessel
					type = HasResource
					completeInSequence = true
					resource = Dirt
					minQuantity = 1400.0
					maxQuantity = 2200.0
				}
				PARAMETER { name = HasResourceCapacityForHab
					type = HasResourceCapacity
					completeInSequence = true
					resource = Dirt
					minQuantity = 2000.0
					maxQuantity = 2200.0
				}
			}
			PARAMETER { name = CreateSoilVPG
				type = VesselParameterGroup
				vessel = Hab
				hideVesselName = true
				hideChildren = true
				completeInSequence = true
				disableOnStateChange = true
				title = Create farmable soil
				notes = Compost Waste and Organic material in Recycler and then convert dirt into soil in the Central Hub.
				PARAMETER { name = HasResourceCompostInVessel
					type = HasResource
					completeInSequence = true
					resource = Soil
					minQuantity = 1995
					maxQuantity = 2200
				}
			}
			PARAMETER { name = AfterSoil
				type = Duration
				duration = 10s
			}
		}
		
		PARAMETER { name = WaterSequence
			type = Sequence
			title = Water
			completeInSequence = true
			failWhenCompleteOutOfOrder = false
			hiddenParameter = MakeWaterVPG
			hiddenParameter = kOSparam_Hab1_bonus
			hiddenParameter = kOSparam_Hab2
			hiddenParameter = kOSparam_Hab2_bonus
			hiddenParameter = WaterResourceProduction
				
			PARAMETER { name = GetHydrazineVPG
				type = VesselParameterGroup
				vessel = Hab
				hideVesselName = true
				hideChildren = true
				completeInSequence = true
				disableOnStateChange = true
				title = Make Water
				PARAMETER { name = kOSparam_Hab1
					type = HasResource
					resource = Hydrazine
					minQuantity = 50.0
					maxQuantity = 100.0
					title = Get Hydrazine
					notes = The landing stage of the MAV should have some left over Hydrazine and chemical processing units.
				}
			}
			PARAMETER { name = kOSparam_Hab1_bonus
				optional = true
				type = AtLeast
				count = 99
				title = Build water generator
				notes = On top of the Hab, remove hab canvas and stack hydrazine tank on top of the universal gas tanks, then stack the chemical plant on top of the hydrazine tank.
			}
			PARAMETER { name = kOSparam_Hab2
				type = HasResource
				resource = Hydrogen
				minQuantity = 50.0
				maxQuantity = 100.0
				title = Create Hydrogen
				notes = Split hydrazine into Hydrogen Gas, which can be stored in the reconfigurable tanks.
			}
			PARAMETER { name = kOSparam_Hab2_bonus
				optional = true
				type = AtLeast
				count = 99
				title = Yeah... I blew myself up.
			}
			PARAMETER { name = WaterResourceProduction
				type = ResourceConsumption
				resource = Water
				minRate  = -0.0008
				title = Produce water for crops
				notes = Recipe for water: Take hydrogen. Add oxygen. Burn.
			}
		}
	}
//#endregion
//#region		Act 1 - Soil and Water (BEHAVIOURS)
	BEHAVIOUR { name = DirtWaypoint  // index=0
		type = WaypointGenerator
		WAYPOINT { name = Low Perchlorate Regolith
			hidden = true
			icon = sample
			altitude = 0.0
			latitude = 42.9
			longitude = 49.2
		}
	}
	BEHAVIOUR { name = Act1_DialogBoxes
		type = DialogBox
		DIALOG_BOX { name = RegolithAnalysis1
            position = CENTER
            title = Martian Dirt sample analysis
            condition = PARAMETER_COMPLETED
            parameter = kOSparam_Hab0
            TEXT
            {
                text = Andy Weir didn't know yet, but Martian regolith may contain high amounts of Perchlorates which would be toxic to plants... \n\nScreenshot the data on the next page and find the lat/lon location of where the lowest perchlorate martian dirt might be hiding.
            }
		}
		DIALOG_BOX { name = RegolithAnalysis2
            position = CENTER
            title = Martian Dirt sample analysis
            condition = PARAMETER_COMPLETED
            parameter = kOSparam_Hab0
			IMAGE
            {
                url = zKB1_TheMartian/images/RegolithData
            }
		}
		DIALOG_BOX { name = RoverDirt
            position = CENTER
            title = Dig up Dirt
            condition = PARAMETER_COMPLETED
            parameter = RoverDirtVPG
            IMAGE
            {
                url = zKB1_TheMartian/images/TheMartianDirt0
            }
			BREAK { }
			TEXT
            {
                text = Playing in the dirt montage... 
            }
		}
		DIALOG_BOX { name = HabDirt
            position = CENTER
            title = Dump Dirt into the hab
            condition = PARAMETER_COMPLETED
            parameter = HabDirtVPG
			IMAGE
            {
                url = zKB1_TheMartian/images/TheMartianDirt1
            }
			BREAK { }
            TEXT
            {
                text = F__k you Mars! 
            }
		}
		DIALOG_BOX { name = CreateSoil
            position = CENTER
            title = Create Soil
            condition = PARAMETER_COMPLETED
            parameter = CreateSoilVPG
			IMAGE
            {
                url = zKB1_TheMartian/images/compost1
            }
			BREAK { }
            TEXT
            {
                text = stir vigorously
                fontSize = 48
                fontColor = #DDDDDD
            }
			BREAK { }
			IMAGE
            {
                url = zKB1_TheMartian/images/compost2
            }
        }

		DIALOG_BOX { name = CreateWater
            position = CENTER
            title = The problem is water
            condition = PARAMETER_COMPLETED
            parameter = AfterSoil
            TEXT
            {
                text = The problem is water... I have created one-hundred and twenty-six square meters of soil. But each cubic meter needs forty liters of water to be farmable. So, I gotta  ake a lot of water. 
            }
			BREAK { }
			IMAGE
            {
                url = zKB1_TheMartian/images/TheMartianDirt2
            }
			BREAK { }
            TEXT
            {
                text = Fortunately, I know the recipe. Take hydrogen. Add oxygen. Burn. Unfortunately... burn. -- I have hundreds of liters of unused Hydrazine from the  DV. If I run the Hydrazine over an iridium catalyst, it will separate into N2 and H2...
                fontSize = 48
                fontColor = #DDDDDD
            }
        }
		DIALOG_BOX { name = HydrazineTank
            position = CENTER
            title = Hydrazine tank installed in the hab.
            condition = PARAMETER_COMPLETED
            parameter = GetHydrazineVPG
            TEXT
            {
                text = I have hundreds of liters of unused Hydrazine from the MDV. If I run the Hydrazine over an iridium catalyst, it will separate into N2 and H2...
            }
			BREAK { }
			IMAGE
            {
                url = zKB1_TheMartian/images/hydrazine
            }
        }
		DIALOG_BOX { name = HydrogenTank
            position = CENTER
            title = Yeah... I blew myself up.
            condition = PARAMETER_COMPLETED
            parameter = kOSparam_Hab2_bonus
            TEXT
            {
                text = Forgot to account for excess Oxygen... because I'm stupid!
            }
			BREAK { }
			IMAGE
            {
                url = zKB1_TheMartian/images/hydrogen
            }
        }
		DIALOG_BOX { name = MakeWater
            position = CENTER
            title = Water Condensing
            condition = PARAMETER_COMPLETED
            parameter = WaterResourceProduction
            TEXT
            {
                text = Make Water
            }
			BREAK { }
			IMAGE
            {
                url = zKB1_TheMartian/images/water
            }
        }
	}
//#endregion

//#region		Act 2 - Communications (PARAMETERS)
	PARAMETER {	name = Act_1
		type = Sequence
		title = Act 1: Mars will come to fear my botany powers
		completeInSequence = true
		failWhenCompleteOutOfOrder = false
		hiddenParameter = FoodSequence
		//hiddenParameter = PathfinderSequence
		hiddenParameter = AirlockBoomSequence

		PARAMETER { name = FoodSequence
			type = Sequence
			title = Food
			completeInSequence = true
			failWhenCompleteOutOfOrder = false
			hiddenParameter = GrowFoodVPG
			
			PARAMETER { name = GrowFoodVPG
				type = VesselParameterGroup
				vessel = Hab
				hideVesselName = true
				hideChildren = true
				completeInSequence = true
				disableOnStateChange = true
				title = Grow Food
				PARAMETER { name = HasFood
					type = HasResource
					completeInSequence = true
					resource = Food
					minQuantity = 500.0
					title = Enough potatoes to last until Sol 480
				}		
			}
		}

		PARAMETER { name = AirlockBoomSequence
			type = Sequence
			title = AirlockBoom
			
			optional = true
			failWhenCompleteOutOfOrder = true
			completeInSequence = false
			hidden = true
			hideChildren = true
			disableOnStateChange = true
			
			PARAMETER { name = AirlockVPG
				type = VesselParameterGroup
				vessel = Hab

				PARAMETER { name = AirlockNotHere
					type = PartValidation
					part = KKAOSS.gangway.airlock
					minCount = 0
					maxCount = 0
				}
			}

			PARAMETER { name = AirlockDialogWait
				type = Duration
				duration = 5s
			}
		}
	}

	PARAMETER { name = kOSparam_Rover1
		type = AtLeast
		count = 99
		title = Looking for some hot stuff!!
	}
	PARAMETER { name = kOSparam_Hab3
		type = AtLeast
		count = 99
		title = Crops are growing.
	}
	PARAMETER { name = kOSparam_Hab4
		type = AtLeast
		count = 99
		title = BOOOM!!
	}
	PARAMETER { name = kOSparam_Hab5
		type = AtLeast
		count = 99
		title = Patched the big hole in the Hab!
	}
	PARAMETER { name = kOSparam_Pathfinder1
		type = AtLeast
		optional = true
		disableOnStateChange = true
		count = 99
		title = Are you receiving me?
	}
	PARAMETER { name = kOSparam_Pathfinder2
		type = AtLeast
		count = 99
		title = Make first contact!
	}
	PARAMETER { name = kOSparam_Pathfinder3
		type = AtLeast
		count = 99
		title = hack the rover firmware
	}
	PARAMETER { name = kOSparam_Pathfinder4
		type = AtLeast
		count = 99
		title = Communicate with NASA over text
	}

//#endregion
//#region		Act 2 - Communications (BEHAVIOURS)
	BEHAVIOUR { name = Act2_DialogBoxes
		type = DialogBox
		DIALOG_BOX { name = AirlockBoom
            position = CENTER
            title = KAAAA-BOOOOM!
            condition = PARAMETER_COMPLETED
            parameter = AirlockDialogWait
            TEXT
            {
                text = Mark steps into the airlock. Closes the door behind him. As the depressurization process begins, the canvas starts to STRETCH... And the sheet RIPS. The Hab breaches. In one-tenth of a second, the tear travels the length of the airlock -- The full force of the Hab’s atmosphere rushes through the breach... KAAAA-BOOOOM! The airlock (with Mark in it) is LAUNCHED LIKE A CANNONBALL. It flies forty meters through the air --
            }
			IMAGE
            {
                url = zKB1_TheMartian/images/airlock1
            }
        }
		
		DIALOG_BOX { name = HabPatch
            position = CENTER
            title = Patch the big hole in the Hab!
            condition = PARAMETER_COMPLETED
            parameter = kOSparam_Hab5
            TEXT
            {
                text = Mark covers the hole with Hab canvas. Begins strapping it in place with duct tape. Doubles up the tape in a circular pattern. Studies his work. It’s not pretty, but with a little luck... Mark repressurizes the Hab. Watches the canvas stretch as the pressure  qualizes. He holds his breath... The canvas holds.
            }
			IMAGE
            {
                url = zKB1_TheMartian/images/ducttapehab
            }
        }

		DIALOG_BOX { name = RoverHeat
            position = CENTER
            title = Warm up the rover cabin!
            condition = PARAMETER_COMPLETED
            parameter = kOSparam_Rover1
            TEXT
            {
                text = Looking for some hot stuff
			}
			IMAGE
            {
                url = zKB1_TheMartian/images/hotstuff
            }
        }

		DIALOG_BOX { name = JPLImageReceived
            position = CENTER
            title = JPL receives first image
            condition = PARAMETER_COMPLETED
            parameter = kOSparam_Pathfinder1
            TEXT
            {
                text = Mark didn't want to get more flags to make YES and NO signs, but luckily the camera can nod up and down.
            }
			IMAGE
            {
                url = zKB1_TheMartian/images/JPLImageReceived
            }
        }

		DIALOG_BOX { name = PathfinderContact
            position = CENTER
            title = Mark Receives First Reply
            condition = PARAMETER_COMPLETED
            parameter = kOSparam_Pathfinder2
			IMAGE
            {
                url = zKB1_TheMartian/images/PathfinderContact
            }
        }

		DIALOG_BOX { name = HackFirmware
            position = CENTER
            title = firmware instructions
            condition = PARAMETER_COMPLETED
            parameter = kOSparam_Pathfinder3
            TEXT
            {
                text = Now that we can have more complicated conversations, the smart people at NASA have sent me instructions on how to hack the rover so that it can talk to Pathfinder. If I hack a tiny bit of code, just a few numbers and their hex equivalents in the Rover’s comm system firmware, NASA can link the rover to Pathfinder’s broadcasting frequency... and we’re in business.
            }
			IMAGE
            {
                url = zKB1_TheMartian/images/HackFirmware
            }
        }

		DIALOG_BOX { name = textingComms
            position = CENTER
            title = hacking rover firmware
            condition = PARAMETER_COMPLETED
            parameter = kOSparam_Pathfinder4
            TEXT
            {
                text = Mark, this is Vincent Kapoor. We’ve been watching you since Sol 54...The whole world is rooting for you. Amazing job, getting Pathfinder. We’re working on rescue plans....
            }
			IMAGE
            {
                url = zKB1_TheMartian/images/textingComms
            }
        }
    }
//#endregion

}